<!DOCTYPE html>
<html>
<head>
<title>Draft to WordPress</title>
<base target="_top">
<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
<style type="text/css">
/**
 * Reset
 */
html, body {
	margin: 0;
	padding: 0;
	height: 100%;
}

* {
	box-sizing: border-box;
	-moz-box-sizing: border-box;
	-webkit-box-sizing: border-box;
}

textarea,
input,
body {
	font: 14px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen-Sans", "Ubuntu", "Cantarell", "Helvetica Neue", sans-serif;
}

body {
	background: #e8eff3;
	color: #2E4453;
}

svg {
	fill: currentColor;
}

/**
 * General
 */

.container {
	height: 100%;
	overflow: hidden;
	display: flex;
	flex-direction: column;
}

.header {
	overflow: hidden;
	display: flex;
	flex-direction: column;
	flex-shrink: 0;
}

.header h1 {
	font-size: 100%;
	background: #0087be;
	margin: 0;
	padding: 12px 16px;
	color: #fff;
	font-weight: 600;
	border-bottom: 1px solid #0079aa;
}

.header h1 svg {
	float: left;
	margin-right: 8px;
	width: 24px;
	height: 24px;
}

.header .header__help-text {
	background: #fff;
	padding: 4px 16px;
	border-bottom: 1px solid #c8d7e0;
}

.sites-list {
	display: flex;
	flex-direction: column;
	flex: 1;
	overflow: auto;
}

.sites-list ul {
	list-style: none;
	margin: 0;
	padding: 0;
}

.sites-list ul li {
	border-bottom: 1px solid #c8d7e0;
	padding: 16px;
	overflow: hidden;
}

.sites-list ul li button {
	float: right;
}

.sites-list ul li .sites-list__blavatar {
	width: 34px;
	height: 34px;
	float: left;
	margin-right: 8px;
	background: #fff;
	padding: 1px;
}

.sites-list ul li .sites-list__blavatar img {
	width: 32px;
	height: 32px;
}

.sites-list ul li .sites-list__sitename {
	line-height: 1.2;
	float: left;
	width: calc( 100% - 140px );
	color: #668EAA;
	position: relative;
}

.sites-list ul li .sites-list__sitename a.sites-list__title {
	color: #2E4453;
	display: block;
	text-decoration: none;
	overflow: hidden;
	text-overflow: ellipsis;
}

.sites-list ul li .sites-list__sitename a:hover {
	color: #4f748e;
}


.sites-list ul li .sites-list__sitename em {
	font-size: 11px;
	font-style: normal;
	color: #668EAA;
}

.sites-list__delete-site {
	width: 18px;
	height: 18px;
	display: none;
	position: absolute;
    top: -4px;
    right: 0;
	color: #2e4453;
}

.sites-list__delete-site:hover {
	color: #4f748e;
}

.sites-list ul li:hover .sites-list__delete-site {
	display: block;
}

.sites-list__post-link {
    padding: 15px 0 0 0;
	display: block;
	clear: both;
}

.sites-list__post-link a {
	text-decoration: underline;
	color: #0087be;
}

/* Disabled button while saving draft */
.sites-list__save-draft:disabled {
	cursor: default;
	position: relative;
}

.sites-list__save-draft:disabled:hover {
	background: #f3f7f9;
	border-color: #e2e6e8;
	opacity: 1;
	color: rgba( 51, 51, 51, .5 );	/* I know, not pretty, but we're working with CSS bleed upstream from Docs */
}

.sites-list__save-draft:disabled:before {	/* This label simply covers the "Update Draft" button */
    content: 'Saving...';
    display: inline-block;
    position: absolute;
    background: #ffffff;
    left: 0;
    right: 0;
    opacity: 1;
    border-radius: 6px;
}

.sites-list__save-draft:disabled:hover:before {
	background: #f3f7f9;
	border-color: #e2e6e8;
	opacity: 1;
	color: rgba( 51, 51, 51, .5 );
}


/**
 * Footer
 */

.footer {
	border-top: 1px solid #c8d7e0;
	margin: auto 0 0;
	display: flex;
	flex-direction: row;
	flex-shrink: 0;
	height: 40px;
}

.footer a {
	text-decoration: none;
	color: #668eaa;
	text-transform: uppercase;
	font-size: 12px;
	margin: 0;
	line-height: 2.1;
	padding: 8px;
	display: inline-block;
}

.footer a:hover {
	color: #2e4453;
}

.footer svg {
	width: 24px;
	height: 24px;
}

.footer .footer__add-site {
	flex: 1;
}

.footer .footer__add-site svg {
	float: left;
	margin-right: 4px;
}

.footer .footer__help-link {
	display: inline-block;
	flex: 0 1 40px;
	margin: 0 0 0 auto;
}

.footer .footer__help-link a {
	overflow: hidden;
	outline: 0;
	border-left: 1px solid #c8d7e0;
}


/**
 * Calypso UI widgets
 */

textarea,
input {
    transition: all .15s ease-in-out;
	border: 1px solid #c8d7e1;
    outline: none;
}

textarea:focus,
input:focus {
	border-color: #0087be;
	box-shadow: 0 0 0 2px #78dcfa;
}

button {
	cursor: pointer;
	font-size: 12px;
	background: #13aadc;
	color: #fff;
	border-radius: 4px;
	border: 1px solid #0987be;
	border-bottom-width: 2px;
}

button:hover,
button:active {
	background: #13aadc;
	color: #fff;
	border-color: #015082;
}

button:active {
	border-bottom-width: 1px;
	border-top-width: 2px;
}

button:focus {
	box-shadow: none;
}
</style>
</head>

<body>
<div class="container">

	<div class="header">
		<h1><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="0" fill="none" width="24" height="24"/><g><path d="M21 11v8c0 1.105-.895 2-2 2H5c-1.105 0-2-.895-2-2V5c0-1.105.895-2 2-2h8l-2 2H5v14h14v-6l2-2zM7 17h3l7.5-7.5-3-3L7 14v3zm9.94-12.94L15.5 5.5l3 3 1.44-1.44c.585-.585.585-1.535 0-2.12l-.88-.88c-.585-.585-1.535-.585-2.12 0z"/></g></svg> Draft to WordPress</h1>

		<div class="header__help-text">
			<p>Pick a site to copy this document to below. It will be saved on your site as a draft.</p>
		</div>

	</div>

	<div class="sites-list">
		<ul></ul>
	</div>
	<textarea style="display: none; width: 100%; height: 50%" id="foo"></textarea>
	<button id="baz" style="display: none">Debug</button>

	<div class="footer">
		<div class="footer__add-site">
			<a href="<?= authorizationUrl ?>"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="0" fill="none" width="24" height="24"/><g><path d="M12 4c4.41 0 8 3.59 8 8s-3.59 8-8 8-8-3.59-8-8 3.59-8 8-8m0-2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm5 9h-4V7h-2v4H7v2h4v4h2v-4h4v-2z"/></g></svg> Add WordPress Site</a>
		</div>
		<div class="footer__help-link">
			<a title="Help" href="https://wordpress.com/help"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="0" fill="none" width="24" height="24"/><g><path d="M12 4c4.41 0 8 3.59 8 8s-3.59 8-8 8-8-3.59-8-8 3.59-8 8-8m0-2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4 8c0-2.21-1.79-4-4-4s-4 1.79-4 4h2c0-1.103.897-2 2-2s2 .897 2 2-.897 2-2 2c-.552 0-1 .448-1 1v2h2v-1.14c1.722-.447 3-1.998 3-3.86zm-3 6h-2v2h2v-2z"/></g></svg></a>
		</div>
	</div>

</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript">
/**
 * On document load, assign click handlers to each button and try to load the
 * user's origin and destination language preferences if previously set.
 */
$( function() {
	loadSites();
} );

// reload every half hour to refresh the auth url
window.setTimeout( function() { google.script.run.showSidebar() }, 1000 * 60 * 30 );

function postToWordPress( el, forceOverwrite ) {
	var site_id = $( this ).attr( 'data-blogid' )
	this.disabled = true;
	google.script.run
		.withSuccessHandler( function( html, element ) {
			loadSites();
		} )
		.withFailureHandler( function( msg, element ) {
			showError( msg, '.sites-list' );
			element.disabled = false;
		} )
		.withUserObject( this )
		.postToWordPress( site_id, forceOverwrite );
}

function loadSites() {
	google.script.run
		.withSuccessHandler( function( sites ) {
			if ( ! ( sites.length > 0 ) ) {
				google.script.run.showSidebar();
			}
			var siteElements = sites.map( siteListItem ).join( '' )
			var $siteList = $( '.sites-list ul' )
			$siteList.html( siteElements )
			$siteList.find( '.sites-list__save-draft' ).click( postToWordPress )
			$siteList.find( '.sites-list__delete-site' ).click( deleteSite )
		} )
		.withFailureHandler( function( msg, element ) {
			showError( msg, $( '.sites-list' ) );
		})
		.withUserObject( this )
		.listSites();
}

function deleteSite() {
	var site_id = $( this ).attr( 'data-blogid' )
	google.script.run
		.withSuccessHandler( function( html, element ) {
			loadSites();
		})
		.withFailureHandler( function( msg, element ) {
			showError( msg, $( '.sites-list' ) );
		})
		.withUserObject( this )
		.deleteSite( site_id );
}

function siteListItem( site ) {
	var blavatar = 'https://secure.gravatar.com/blavatar/e6392390e3bcfadff3671c5a5653d95b'
	if ( site.info.icon && site.info.icon.img ) {
		var blavatar = site.info.icon.img;
	}
	let template = '<li>' +
		'<div class="sites-list__blavatar">' +
			'<img src="' + blavatar + '" alt="" />' +
		'</div>' +
		'<div class="sites-list__sitename">' +
			'<a class="sites-list__title" href="' + site.blog_url + '">' + site.info.name +
			'<br><em>' + site.blog_url + '</em></a>' +
			'<a title="Remove site from this list" class="sites-list__delete-site" data-blogid="' + site.blog_id + '"><svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="0" fill="none" width="24" height="24"/><g><path d="M17.705 7.705l-1.41-1.41L12 10.59 7.705 6.295l-1.41 1.41L10.59 12l-4.295 4.295 1.41 1.41L12 13.41l4.295 4.295 1.41-1.41L13.41 12l4.295-4.295z"/></g></svg></a>' +
		'</div>';

	if ( site.post ) {
		template += '<button class="sites-list__save-draft" data-blogid="' + site.blog_id + '">Update Draft</button>';
	} else {
		template += '<button class="sites-list__save-draft" data-blogid="' + site.blog_id + '">Save Draft</button>';
	}

	if ( site.post ) {
		template += '<span class="sites-list__post-link"><a href="' + site.post.URL + '">Preview on ' + site.info.name + '</a></span>';
	}

	template += '</li>';
	return template;
}

/**
 * Inserts a div that contains an error message after a given element.
 *
 * @param msg The error message to display.
 * @param element The element after which to display the error.
 */
function showError( msg, element ) {
	console.error( msg );
	var div = $( '<div class="error"><svg style="cursor: pointer;" width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="0" fill="none" width="24" height="24"/><g><path d="M17.705 7.705l-1.41-1.41L12 10.59 7.705 6.295l-1.41 1.41L10.59 12l-4.295 4.295 1.41 1.41L12 13.41l4.295 4.295 1.41-1.41L13.41 12l4.295-4.295z"/></g></svg>' + msg + '</div>' );
	$( div ).find( 'svg' ).click( function() {
		$( this ).closest( 'div.error' ).remove();
	} )
	$( element ).after( div );
}
</script>

</body>
</html>
